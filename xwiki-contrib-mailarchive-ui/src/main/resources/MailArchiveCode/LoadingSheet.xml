<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>MailArchiveCode</web>
<name>LoadingSheet</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.jbousque</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1255425870000</creationDate>
<date>1338994760000</date>
<contentUpdateDate>1338994760000</contentUpdateDate>
<version>20.30</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>true</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator>|</separator>
<separators>|,</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>MailArchiveCode.LoadingSheet</name>
<number>0</number>
<className>XWiki.TagClass</className>
<guid>87f035dc-fcbf-4fb0-b242-28695264222a</guid>
<property>
<tags/>
</property>
</object>
<content>{{velocity wiki="true"}}
#set($installed = $services.mailarchive)
#if(!$installed)
#set($disabled="disabled='disabled'")
#else
  #set($xwql = "select doc.fullName, server.id from Document doc, doc.object(MailArchiveCode.ServerSettingsClass) as server where doc.space='MailArchivePrefs'")
  #set($servers = $services.query.xwql($xwql).execute())
  #if($request.button-check)
    #foreach($server in $servers)
      ##set($discard=$services.mailarchive.check($server[0]))
    #end
  #end
  #set($params = $request.parameterMap)

  #foreach($param in $params.entrySet())
    #set($length = $param.key.length())
    #if($param.key.startsWith("button-check-"))
      #set($serverid = $param.key.substring(13, $length))
      #set($action="check")
    #end
    #if($param.key.startsWith("button-load-"))
      #set($serverid = $param.key.substring(12, $length))
      #set($action="load")
    #end
    #if($param.key.startsWith("button-simulate-"))
      #set($serverid = $param.key.substring(16, $length))
      #set($action="simulate")
    #end    
  #end
  #if($!serverid)
    #foreach($server in $servers)
      #if($server[1] == $serverid)
        #set($servername = $server[0])
      #end
    #end
  #end
  
  #if($action == "check")
    #set($discard = $services.mailarchive.check($servername))
  #elseif($action == "load")
    #set($max = $request.input-max-nb)
    #if($max == "-1")
      #set($discard = $services.mailarchive.load($servername))
    #end
    #set($discard = $services.mailarchive.load($servername, $util.parseInteger($request.input-max-nb)))
  #elseif($action == "simulate")
    ## TODO
  #end
#end

{{html wiki="true"}}

= $msg.mailarchive_loading_title =

$msg.mailarchive_loading_description

&lt;form class="xform" method="POST" action="#"&gt;
  &lt;dl&gt;
    &lt;dt&gt;&lt;label for="input-max-nb"&gt;Max number of mails to load in a session&lt;/label&gt;
        &lt;span class="xHint"&gt;Enter -1 to load all mails - can be very slow&lt;/span&gt;
    &lt;/dt&gt;
    &lt;dd&gt;&lt;input type="text" name="input-max-nb" id="input-max-nb" value="10"/&gt;&lt;/dd&gt;
    &lt;dt&gt;&lt;label for="input-debug-mode"&gt;
      &lt;input type="checkbox" name="input-debug-mode" value="input-debug-mode"/&gt; $msg.get('mailarchive_loading_action_debug')
     &lt;/label&gt;
    &lt;/dt&gt;
    &lt;dt&gt;&lt;label for="input-readflag-mode"&gt;
      &lt;input type="checkbox" name="input-readflag-mode" value="input-readflag-mode"/&gt; Load mails already read
    &lt;/label&gt;&lt;dt&gt;
  &lt;/dl&gt;



#if($servers.size() &gt; 0)
#set($total = 0)
|=Server|=Nb Mails available|=Actions
#foreach($servera in $servers)
  #set($server = $servera[0])
  #set($serverobj = $xwiki.getDocument($server).getObject('MailArchiveCode.ServerSettingsClass'))
  #set($nb=$util.parseInteger($serverobj.status))
  #if($nb &lt; 0) 
    #set($status = $msg.get("mailarchive_server_states.${nb}"))
  #else
    #set($status = "$nb")
    #set($total = $total + $nb)
  #end
|[[$serverobj.id / $serverobj.hostname / $serverobj.port / $serverobj.protocol / $serverobj.user / $serverobj.folder&gt;&gt;$server]]|$status|(((
&lt;div class="buttons"&gt;
  &lt;span class="buttonWrapper"&gt;
    &lt;input type="submit" name="button-check-${serverobj.id}" $!disabled value="$msg.get('mailarchive_loading_action_check')"/&gt;
  &lt;/span&gt;
  &lt;span class="buttonWrapper"&gt;
    &lt;input type="submit" name="button-load-${serverobj.id}" $!disabled value="$msg.get('mailarchive_loading_action_load')"/&gt;
  &lt;/span&gt;
  &lt;span class="buttonWrapper"&gt;
    &lt;input type="submit" name="button-simulate-${serverobj.id}" $!disabled value="$msg.get('mailarchive_loading_action_simulate')"/&gt;
  &lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
)))
#end
|All Servers|$total|&lt;span class="buttonWrapper"&gt;&lt;input type="submit" name="button-check" value="$msg.get('mailarchive_loading_action_check')" $!disabled/&gt;&lt;input type="submit" name="button-load" value="$msg.get('mailarchive_loading_action_load')" $!disabled/&gt;&lt;input type="submit" name="button-simulate" value="$msg.get('mailarchive_loading_action_simulate')" $!disabled/&gt;&lt;/span&gt;

#else
  No server is configured, go to [[Administration page&gt;&gt;MailArchive.Admin]] to add at least one.
#end

{{/html}}
{{/velocity}}</content></xwikidoc>
