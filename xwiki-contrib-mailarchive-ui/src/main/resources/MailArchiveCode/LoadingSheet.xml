<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>MailArchiveCode</web>
<name>LoadingSheet</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1353930107000</creationDate>
<date>1354528934000</date>
<contentUpdateDate>1354528934000</contentUpdateDate>
<version>1.1</version>
<title>$services.localization.render('mailarchive.load.title')</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Imported from XAR</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator>|</separator>
<separators>|,</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>MailArchiveCode.LoadingSheet</name>
<number>0</number>
<className>XWiki.TagClass</className>
<guid>87f035dc-fcbf-4fb0-b242-28695264222a</guid>
<property>
<tags/>
</property>
</object>
<content>{{velocity wiki="true"}}
## TODO: use updateObjectFromRequest to save session parameters
## TODO: use $doc.display to display fields from session object(s)
#set($installed = $services.mailarchive)
#if(!$installed)
  #set($disabled="disabled='disabled'")
#else
  ## Loading Parameters creation
  #set($sessionsprefsdoc = $xwiki.getDocument('MailArchivePrefs.LoadingSession_manual'))
  #set($msession = $sessionsprefsdoc.getObject('MailArchiveCode.LoadingSessionClass'))
  #if(!$xwiki.exists('MailArchivePrefs.LoadingSession_manual') || $msession.id != 'manual')
    #set($msession = $sessionsprefsdoc.newObject('MailArchiveCode.LoadingSessionClass'))
$msession
    #set($discard = $msession.set('id', 'manual'))
    #set($discard = $msession.set('maxMailsNb', '-1'))
    #set($discard = $msession.set('withDelete', '0'))
    #set($discard = $msession.set('loadAll', '0'))
    #set($discard = $msession.set('debugMode', '1'))
    #set($discard = $msession.set('simulationMode', '1'))
    #set($discard = $msession.set('recentMails', '0'))
    #set($discard = $sessionsprefsdoc.save('Init'))
$msession
$msession.id
Saved manual session params.
  #end
  #set($sessionsprefsdoc = $xwiki.getDocument('MailArchivePrefs.LoadingSession_schedule'))
  #set($ssession = $sessionsprefsdoc.getObject('MailArchiveCode.LoadingSessionClass'))
  #if(!$xwiki.exists('MailArchivePrefs.LoadingSession_schedule') || $ssession.id != 'schedule')
    #set($ssession = $sessionsprefsdoc.newObject('MailArchiveCode.LoadingSessionClass'))
    #set($discard = $ssession.set('id', 'schedule'))
    #set($discard = $ssession.set('maxMailsNb', '-1'))
    #set($discard = $ssession.set('withDelete', '0'))
    #set($discard = $ssession.set('loadAll', '0'))
    #set($discard = $ssession.set('debugMode', '0'))
    #set($discard = $ssession.set('simulationMode', '0'))
    #set($discard = $ssession.set('recentMails', '0'))
    #set($discard = $sessionprefsdoc.save('Init'))
Saved automatic loading params.
  #end
  #set($max = $request.input-max-nb)
  #set($saveschedule = $request.button-scheduleparams)
  #if(!$max) #set($max = -1) #else #set($max = $util.parseInteger($max)) #end
  #set($xwql = "select doc.fullName, server.id from Document doc, doc.object(MailArchiveCode.ServerSettingsClass) as server where doc.space='MailArchivePrefs'")
  #set($servers = $services.query.xwql($xwql).execute())
  #if($request.button-check)
    #foreach($server in $servers)
      #set($discard=$services.mailarchive.check($server[0]))
    #end
  #end
  #if($request.button-load)
      Not implemented
  #end
  #set($params = $request.parameterMap)

  #foreach($param in $params.entrySet())
    #set($length = $param.key.length())
    #if($param.key.startsWith("button-check-"))
      #set($serverid = $param.key.substring(13, $length))
      #set($action="check")
    #end
    #if($param.key.startsWith("button-load-"))
      #set($serverid = $param.key.substring(12, $length))
      #set($action="load")
    #end
  #end
  #if($!serverid)
    #foreach($server in $servers)
      #if($server[1] == $serverid)
        #set($servername = $server[0])
      #end
    #end
  #end
  
  #if($action == "check")
    #set($discard = $services.mailarchive.check($servername))
  #elseif($action == "load")

    #set($session = $services.mailarchive.session($servername).setLimit($max))
debug SESSION $session
    #set($nbLoaded = $session.loadMails())
    Loaded $nbLoaded emails from server $serverid.
  #end 
#end

{{html wiki="true"}}

$services.localization.render('mailarchive.load.abstract')

&lt;form class="xform" method="POST" action="#"&gt;
  &lt;dl&gt;
    &lt;dt&gt;&lt;label for="input-max-nb"&gt;$services.localization.render('mailarchive.loadingSession.fields.maxMailsNb.label')&lt;/label&gt;
        &lt;span class="xHint"&gt;$services.localization.render('mailarchive.loadingSession.fields.maxMailsNb.hint')&lt;/span&gt;
    &lt;/dt&gt;
    &lt;dd&gt;&lt;input type="text" name="input-max-nb" id="input-max-nb" value="10"/&gt;&lt;/dd&gt;
    &lt;dt&gt;&lt;label for="input-debug-mode"&gt;
      &lt;input type="checkbox" name="input-debug-mode" value="input-debug-mode"/&gt; $services.localization.render('mailarchive_loading_action_debug')
     &lt;/label&gt;
    &lt;/dt&gt;
    &lt;dt&gt;&lt;label for="input-simulation-mode"&gt;
      &lt;input type="checkbox" name="input-simulation-mode" value="input-simulation-mode"/&gt; $services.localization.render('mailarchive_loading_action_simulate')
     &lt;/label&gt;
    &lt;/dt&gt;
    &lt;dt&gt;&lt;label for="input-readflag-mode"&gt;
      &lt;input type="checkbox" name="input-readflag-mode" value="input-readflag-mode"/&gt; $services.localization.render('mailarchive_loading_action_readflag')
    &lt;/label&gt;&lt;dt&gt;
    &lt;dt&gt;&lt;label for="input-recentflag-mode"&gt;
      &lt;input type="checkbox" name="input-recentflag-mode" value="input-recentflag-mode"/&gt; $services.localization.render('mailarchive_loading_action_recentflag')
     &lt;/label&gt;
    &lt;/dt&gt;
    &lt;dt&gt;&lt;label for="input-delete-mode"&gt;
      &lt;input type="checkbox" name="input-delete-mode" value="input-delete-mode"/&gt; $services.localization.render('mailarchive_loading_action_delete')
     &lt;/label&gt;
    &lt;/dt&gt;
  &lt;/dl&gt;

#if($servers.size() &gt; 0)
#set($total = 0)
|=$services.localization.render('mailarchive.load.table.headers.server')|=$services.localization.render('mailarchive.load.table.headers.server')|=$services.localization.render('mailarchive.load.table.headers.server')|=$services.localization.render('mailarchive.load.table.headers.server')
#foreach($servera in $servers)
  #set($server = $servera[0])
  #set($serverobj = $xwiki.getDocument($server).getObject('MailArchiveCode.ServerSettingsClass'))
  #set($nb=$util.parseInteger($serverobj.status))
  #if($nb &lt; 0) 
    #set($status = $services.localization.render("mailarchive.servers.connectionStatus.${nb}"))
  #else
    #set($status = "$nb")
    #set($total = $total + $nb)
  #end
|[[$serverobj.id / $serverobj.hostname / $serverobj.port / $serverobj.protocol / $serverobj.user / $serverobj.folder&gt;&gt;$server]]|$serverobj.state|$status|(((
&lt;div class="buttons"&gt;
  &lt;span class="buttonwrapper"&gt;
    &lt;input type="submit" name="button-check-${serverobj.id}" $!disabled value="$services.localization.render('mailarchive.load.check.submit')"/&gt;
    &lt;input type="submit" name="button-load-${serverobj.id}" $!disabled value="$services.localization.render('mailarchive.load.load.submit')"/&gt;
    &lt;input type="submit" name="button-switch-${serverobj.id}" $!disabled value="$services.localization.render('mailarchive.load.switch.submit')"/&gt;
  &lt;/span&gt;
&lt;/div&gt;
)))
#end
|All Servers|/|$total|&lt;span class="buttonwrapper"&gt;&lt;input type="submit" name="button-check" value="$services.localization.render('mailarchive.load.check.submit')" $!disabled/&gt;&lt;input type="submit" name="button-load" value="$services.localization.render('mailarchive.load.load.submit')" $!disabled/&gt;&lt;/span&gt;

= Automatic loading =

Go to [[Scheduler job page&gt;&gt;Scheduler.MailArchiveLoadingJob]] to activate / deactivate automatic loading.
Scheduled job, once activated, will automatically load mails from servers in ACTIVE state, using the parameters below:&lt;br/&gt;&lt;br/&gt;

|=Parameter|=Value
|$services.localization.render('mailarchive.loadingSession.fields.maxMailsNb.label')|$ssession.maxMailsNb
|$services.localization.render('mailarchive.loadingSession.fields.debugMode.label')|$ssession.debugMode
|$services.localization.render('mailarchive.loadingSession.fields.simulationMode.label')|$ssession.simulationMode
|$services.localization.render('mailarchive.loadingSession.fields.loadAll.label')|$ssession.loadAll
|$services.localization.render('mailarchive.loadingSession.fields.recentMails.label')|$ssession.recentMails
|$services.localization.render('mailarchive.loadingSession.fields.withDelete.label')|$ssession.withDelete

&lt;br/&gt;&lt;br/&gt;

&lt;div class="buttons_schedule"&gt;
  &lt;span class="buttonwrapper"&gt;
    &lt;input type="submit" id="button-scheduleparams" name="button-scheduleparams" $!disabled value="Use parameters from top of this page for scheduled job"/&gt;
  &lt;/span&gt;
&lt;/div&gt;


#else
  No server is configured, go to [[Administration page&gt;&gt;MailArchive.Admin]] to add at least one.
#end

&lt;/form&gt;

{{/html}}
{{/velocity}}</content></xwikidoc>
