<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>MailArchiveCode</web>
<name>MailClassSheet</name>
<language></language>
<defaultLanguage>fr</defaultLanguage>
<translation>0</translation>
<parent>MailArchiveCode.MailClass</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1353417892000</creationDate>
<date>1353417892000</date>
<contentUpdateDate>1353417892000</contentUpdateDate>
<version>1.1</version>
<title>$doc.display("messagesubject")</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment>Import</comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.1</syntaxId>
<hidden>false</hidden>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<disabled>0</disabled>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<disabled>0</disabled>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<disabled>0</disabled>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<disabled>0</disabled>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>MailArchiveCode.MailClassSheet</name>
<number>0</number>
<className>XWiki.StyleSheetExtension</className>
<guid>ff7f5a8d-09f8-41b7-943f-887e40646f5f</guid>
<property>
<cache>default</cache>
</property>
<property>
<code>.mail_header { 
width:99%;
clear:both;
display:block;
}


.mail_subject { 
width:90%;
clear:both;
}

.mail_header_date { 
width:90%;
clear:both;
}

.mail_header_recipients { 
width:99%;
display:block;
clear:both;
}

.mail_part_header {
text-align:left;
font-weight:bold;
width:100%;
margin-left:3%;
font-size:+1em;
float:left;
}


.mail_body_html { 
width:100%;
clear:both;
}

.mail_header_recipients dd {
   float: left;
   width: 80%;
   margin: 0 0 0.5em 0.25em;
   padding: 0;
   overflow:scroll;
   height:60px;
}

dd.mail_header_from {
   float: left;
   width: 80%;
   margin: 0 0 0.5em 0.25em;
   padding: 0;
   overflow:visible;
   height:10px;
}


.mail_header_recipients dt {
   clear: both;
   width: 15%;
   float: left;
   padding-right: 5px;
   font-weight: bold;
   text-align: right;
}

</code></property><property><name>mail_style</name>
</property>
<property>
<parse>0</parse>
</property>
<property>
<use>always</use>
</property>
</object>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<disabled>0</disabled>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator>|</separator>
<separators>|,</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>MailArchiveCode.MailClassSheet</name>
<number>0</number>
<className>XWiki.TagClass</className>
<guid>f17ba4a9-2e64-453f-ae98-767f0d25ee35</guid>
<property>
<tags>
<value>MIGOK</value>
</tags>
</property>
</object>
<content>{{velocity filter="none"}}
{{html clean="false" wiki="true"}}
$doc.use("MailArchiveCode.MailClass")
$xwiki.ssx.use("MailArchiveCode.MailClass")
#set($relatedtopicid = $doc.get("topicid"))
#set($xwql = "select doc.fullName from Document doc, doc.object(MailArchiveCode.MailTopicClass) as topic where topic.topicid=:relatedtopicid")
#set ($relatedTopic = $services.query.xwql($xwql).setLimit(1).bindValue('relatedtopicid', $relatedtopicid).execute())
#if($relatedTopic.size()&gt;0) 
  #set($relatedTopic = $relatedTopic[0])
#else
  #set($relatedTopic = "")
#end
## used in groovy block below, so put in xcontext
#if($relatedTopic)
$xcontext.put("relatedTopic", $relatedTopic)
#else
$xcontext.put("relatedTopic", "")
#end
#set ($showdetails = $request.get('showdetails'))
&lt;div class="mail_header"&gt;

#if ("$showdetails" != "false")
{{html wiki="false"}}
&lt;a style="float:right;" href="" onclick="Effect.toggle('mail_hidden_headers', 'slide'); return false;" title="Click to open hidden information"&gt;Show details &lt;img  class="showhidearrow" src="$xwiki.getDocument('XWiki.GSESkin').getURL('download')/black-content-more.gif" border="0" alt="Edit Menu" height="15" width="15" style="padding:0px;margin:0px;"/&gt;&lt;/a&gt;
{{/html}}
&lt;div class="mail_header_recipients"&gt; 
&lt;div id="mail_hidden_headers" style="display:none"&gt;
#set($class = $doc.getObject('MailArchiveCode.MailClass').xWikiClass)

{{container layoutStyle="columns"}}

(((
#foreach($propname in ["from", "to", "cc", "topicsubject", "messagesubject"])
#set($prop = $class.get("$propname"))
  ; $prop.prettyName
  : $doc.display($prop.getName(), 'view')
#end
)))

(((
#foreach($propname in ["topicid", "messageid", "inreplyto", "references"])
#set($prop = $class.get("$propname"))
  ; $prop.prettyName
  : $doc.display($prop.getName(), 'view')
#end
)))

{{/container}}

&lt;/div&gt;
#end
&lt;/div&gt;

-----
{{/html}}
{{/velocity}}
{{groovy}}
import java.text.*;

def sdf = new SimpleDateFormat("EEE, dd MMM yyyy HH:mm:ss ZZZZZ")
def obj = doc.getObject("MailArchiveCode.MailClass")
def date = sdf.parse(obj.date)
def sdf2 = new SimpleDateFormat("dd/MM/yyyy HH:mm")
def from = doc.display("from")
def start = from.indexOf("&lt;p&gt;")
if (start != -1) { from = from.substring(start+3) }
def end = from.indexOf("&amp;") 
if (end != -1) { from = from.substring(0,end-1) }
def sensitivity = doc.display("sensitivity")
if (sensitivity == null || sensitivity == "") {
  sensitivity = "normal"
}
def importance = doc.display("importance")
if (importance == null || importance == "") {
  importance = "normal"
}
def str = ""
if (request.get('showdetails') != "false")
{
  def best = obj.getProperty('bestanswer')
  if (best != null) { best = best.value } else { best=false }
  if (request.get('best') == "set") 
  { 
    obj.set('bestanswer', 1)
    best = 1
    doc.save('set as best answer')
  } else if (request.get('best') == "unset") 
  {
    obj.set('bestanswer', 0)
    best = 0
    doc.save('unset best answer')
  }
  /*if (best==1) { str += " [[image:XWiki.GSESkin@OKK.gif&gt;&gt;doc:${doc.space}.${doc.name}||queryString=\"best=unset\"]] " } else { str += " [[Set as best answer&gt;&gt;doc:${doc.space}.${doc.name}?best=set]] " }*/
} else {
  // Retrieved from velocity through xcontext
  def relatedTopic = xcontext.get("relatedTopic")
  println("[[Permalink&gt;&gt;doc:${doc.space}.${doc.name}||queryString=\"topic=${relatedTopic}\"]]")
}
def iconS = ""
switch (sensitivity) {
  case "normal" : iconS = "email"
    break
  case "encrypted" : iconS = "key"
    break
  case "private" : iconS = "error"
    break
  case "confidential" : iconS = "exclamation"
    break
  default : iconS = "error"
    break
}
def prefix = ""
if (importance == "high") {
  prefix = """(% style="color:red" %)[[image:icon:exclamation]] Important """
}
println(prefix + 'Message from **' + from + '** on **' + sdf2.format(date) + "** - [[image:icon:" + iconS + "]] " + sensitivity + " " + str)

def html = ""
URL url = new URL("${xwiki.getDocument('MailArchiveCode.HtmlProvider').getExternalURL().replaceAll(~/varsovie.gemalto.com/,'localhost').replaceAll(~/r-wikiggs.gemalto.com/, 'localhost:8085')}?page=${doc.web}.${doc.name}&amp;xpage=plain")
URLConnection uc = url .openConnection()
BufferedReader br = new BufferedReader(
new InputStreamReader(
uc.getInputStream()))
String inputLine=null
while ((inputLine = br.readLine()) != null) {
  html += inputLine
}
br.close()
xcontext.put('html',html)


{{/groovy}}
{{velocity filter="none"}}
{{html clean="false" wiki="true"}}
-----

#foreach ($attachment in $doc.getAttachmentList()) #if(!$!xcontext.get('html').contains($!doc.getAttachmentURL($attachment.getFilename()))) #mimetypeimg($attachment.getMimeType().toLowerCase() $attachment.getFilename().toLowerCase()) [[$attachment.getFilename()&gt;&gt;attach:$attachment.getFilename()]] #end #end

-----
{{/html}}
{{/velocity}}
{{groovy}}
def obj = doc.getObject("MailArchiveCode.MailClass")
def attachedMails = obj.getProperty('attachedMails')
if (attachedMails != null) {
  attachedMails = attachedMails.value.trim()
  if (attachedMails != "") {
    println ""
    println "{{html clean='false' wiki='true'}}"
    print "**Attached Emails**: "
    attachedMails.split(',').each() { attachedMail -&gt;
      print "&lt;img src=\"/${xwiki.getWebAppPath()}resources/icons/silk/folder.gif\"/&gt; &lt;a href=\"${xwiki.getDocument(attachedMail).getURL()}\"&gt;${xwiki.getDocument(attachedMail).title}&lt;/a&gt; "
    }
    println "{{/html}}"
    println ""
    println "-----"
  }
}
{{/groovy}}
{{velocity filter="none"}}
{{html clean="false" wiki="true"}}
#set ($obj = $doc.getObject("MailArchiveCode.MailClass"))
#set($htmlbody = $obj.getProperty("bodyhtml").value)
#set($body = $obj.getProperty("body").value)
&lt;div class="mail_body"&gt;
#if ($obj.bodyhtml != "")
{{html wiki='false'}}
&lt;iframe id="htmlframe" src="$xwiki.getDocument('MailArchiveCode.HtmlProvider').getURL()?page=${doc.web}.${doc.name}&amp;xpage=plain" width="100%" height="500px"&gt;$body&lt;/iframe&gt;
{{/html}}
#elseif (${body.startsWith("&lt;html")} || ${body.contains("&lt;br&gt;")} || ${body.contains("&lt;br/&gt;")})
{{html wiki='false'}}
$body
{{/html}}
#else
{{/html}}
$body
{{html clean="false" wiki="true"}}
#end
&lt;/div&gt;
{{/html}}
{{/velocity}}

</content></xwikidoc>